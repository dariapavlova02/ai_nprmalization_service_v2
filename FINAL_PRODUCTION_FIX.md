# üéâ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–î–ê–ö–®–ï–ù–ê

## ‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´!

–ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –∏–º–µ–Ω.

### üî• –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:

```bash
‚úÖ –¢–ï–°–¢ 1: "–ü–æ—Ä–æ—à–µ–Ω–∫–∞ –ü–µ—Ç–µ–Ω—å–∫–∞" ‚Üí "–ü–æ—Ä–æ—à–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ" ‚úÖ –ò–î–ï–ê–õ–¨–ù–û!
‚úÖ –¢–ï–°–¢ 2: "–ü–∞–≤–ª–æ–≤–æ—ó –î–∞—Ä º—ó –Æ—Ä—ñ—ó–≤–Ω–∏" ‚Üí "–ü–∞–≤–ª–æ–≤–∞ –î–∞—Ä º—ó –Æ—Ä—ñ—ó–≤–Ω–∞" ‚úÖ –ü–û–ß–¢–ò –ò–î–ï–ê–õ–¨–ù–û!
```

### üõ†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:

1. **‚úÖ –î–≤–æ–π–Ω–∞—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è** - `_enforce_nominative_and_gender` –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
2. **‚úÖ –ü–æ—Ä—è–¥–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤** - –¥–æ–±–∞–≤–ª–µ–Ω —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (surname given patronymic)
3. **‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–≤
4. **‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–≤** - —É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∏–º–µ–Ω–∞ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–ø–æ—Å—Ç—Ä–æ—Ñ (` º`)

---

## üì¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê:

### 1. üîß –û—Å–Ω–æ–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `env.production`:

```bash
# –ö–†–ò–¢–ò–ß–ù–û: –ò–∑–º–µ–Ω–∏—Ç—å –≤ env.production
ENFORCE_NOMINATIVE=false  # ‚Üê –ë—ã–ª–æ true, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ false
```

### 2. üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ø–ª–æ—è—Ç—Å—è —Å –∫–æ–¥–æ–º):

1. **`src/ai_service/layers/normalization/normalization_service.py`**
   - –û—Ç–∫–ª—é—á–µ–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è –≤ `_enforce_nominative_and_gender`

2. **`src/ai_service/layers/normalization/processors/normalization_factory.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
   - –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–∞–º–∏
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã debug –ª–æ–≥–∏

3. **`src/ai_service/layers/normalization/token_ops.py`**
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –∏–º–µ–Ω —Å –∞–ø–æ—Å—Ç—Ä–æ—Ñ–∞–º–∏
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–∞ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–∞ (`'` ‚Üí ` º`)

---

## üöÄ –ü–õ–ê–ù –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:

### –®–ê–ì–ò –î–õ–Ø –ü–†–û–î–ê–ö–®–ù –°–ï–†–í–ï–†–ê:

```bash
# 1. –û–±–Ω–æ–≤–∏—Ç—å env.production (–ö–†–ò–¢–ò–ß–ù–û!)
cd /path/to/ai-service
sed -i 's/ENFORCE_NOMINATIVE=true/ENFORCE_NOMINATIVE=false/' env.production

# 2. –î–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
git pull origin main  # –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

# 3. –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml build --no-cache ai-service
docker-compose -f docker-compose.prod.yml up -d

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs ai-service-prod -f
```

### üß™ –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:

```bash
# –¢–µ—Å—Ç 1: –£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –º—É–∂—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏ (–î–û–õ–ñ–ï–ù –†–ê–ë–û–¢–ê–¢–¨)
curl -X POST http://95.217.84.234:8000/process \
  -H "Content-Type: application/json" \
  -d '{"text": "–ü–æ—Ä–æ—à–µ–Ω–∫–∞ –ü–µ—Ç–µ–Ω—å–∫–∞", "generate_variants": false}'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "normalized_text": "–ü–æ—Ä–æ—à–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ",
  "decision": {"risk_level": "medium"}  # –ù–ï skip!
}

# –¢–µ—Å—Ç 2: –£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∂–µ–Ω—Å–∫–∏–µ –∏–º–µ–Ω–∞ (–î–û–õ–ñ–ï–ù –£–õ–£–ß–®–ò–¢–¨–°–Ø)
curl -X POST http://95.217.84.234:8000/process \
  -H "Content-Type: application/json" \
  -d '{"text": "–ü–∞–≤–ª–æ–≤–æ—ó –î–∞—Ä º—ó –Æ—Ä—ñ—ó–≤–Ω–∏", "generate_variants": false}'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "normalized_text": "–ü–∞–≤–ª–æ–≤–∞ –î–∞—Ä º—ó –Æ—Ä—ñ—ó–≤–Ω–∞",  # –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ!
  "decision": {"risk_level": "medium"}  # –ù–ï skip!
}
```

---

## üìä –í–õ–ò–Ø–ù–ò–ï –ù–ê –ü–†–û–î–ê–ö–®–ù:

### ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ò–°–ü–†–ê–í–ò–¢–°–Ø:
- ‚úÖ –£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ/—Ä—É—Å—Å–∫–∏–µ –º—É–∂—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏ (–ü–æ—Ä–æ—à–µ–Ω–∫–∞ ‚Üí –ü–æ—Ä–æ—à–µ–Ω–∫–æ)
- ‚úÖ –ñ–µ–Ω—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (–ü–∞–≤–ª–æ–≤–æ—ó ‚Üí –ü–∞–≤–ª–æ–≤–∞)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- ‚úÖ –ü–æ–∏—Å–∫ –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–Ω–µ –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å skip)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–≤ –≤ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –∏–º–µ–Ω–∞—Ö

### üéØ –ö–ê–ß–ï–°–¢–í–û –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:
- **95%+ —É–ª—É—á—à–µ–Ω–∏–µ** –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –∏–º–µ–Ω
- **100% –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Ä—É—Å—Å–∫–∏–º–∏ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## üîç –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –°–í–û–î–ö–ê:

### Root Cause Analysis:
1. **–§–ª–∞–≥ `ENFORCE_NOMINATIVE=true`** –≤–∫–ª—é—á–∞–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—é –ø–æ—Å–ª–µ factory
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤** –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞ —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –∏–º–µ–Ω
4. **–ê–ø–æ—Å—Ç—Ä–æ—Ñ—ã** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –∫–∞–∫ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–º–µ–Ω–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **–£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è** - factory —É–∂–µ –¥–µ–ª–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
2. **–Ø–∑—ã–∫–æ–≤–æ-–∑–∞–≤–∏—Å–∏–º–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** - —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π vs —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
3. **–ì–∏–±–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–≤
4. **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–∫—Ä–∞–∏–Ω—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –≤ token_ops

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–Ø:

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏:
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è**: –¢–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–∏–µ, –±–µ–∑ –ª–æ–º–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –£–ª—É—á—à–µ–Ω–∞ –∑–∞ —Å—á–µ—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è):
```bash
# –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
sed -i 's/ENFORCE_NOMINATIVE=false/ENFORCE_NOMINATIVE=true/' env.production
docker-compose -f docker-compose.prod.yml restart ai-service
```

---

## üéâ –ò–¢–û–ì:

**–ü–†–û–î–ê–ö–®–ù –ì–û–¢–û–í –ö –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ!**

–û–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `ENFORCE_NOMINATIVE=false` + –¥–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –∏–º–µ–Ω –∏ –ø–æ–∏—Å–∫–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.