# Search Layer - File Structure

## Созданная файловая структура

```
src/ai_service/layers/search/
├── __init__.py                           # Основные экспорты слоя поиска
├── contracts.py                          # Интерфейсы и модели данных
├── config.py                            # Конфигурация поиска
├── hybrid_search_service.py             # Главный сервис гибридного поиска
├── elasticsearch_adapters.py            # Адаптеры для Elasticsearch
├── integration_todos.md                 # TODO для интеграции
└── README.md                            # Документация слоя

tests/unit/layers/search/
├── __init__.py                          # Инициализация тестов
└── test_search_imports.py               # Тесты импорта и базовой функциональности
```

## Основные компоненты

### 1. Интерфейсы и контракты (`contracts.py`)

- **SearchService**: Базовый интерфейс для сервисов поиска
- **Candidate**: Модель результата поиска
- **SearchOpts**: Опции и параметры поиска
- **SearchMetrics**: Метрики производительности
- **SearchMode**: Enum режимов поиска (AC, VECTOR, HYBRID)
- **ElasticsearchAdapter**: Базовый интерфейс для ES адаптеров

### 2. Конфигурация (`config.py`)

- **HybridSearchConfig**: Главная конфигурация поиска
- **ElasticsearchConfig**: Конфигурация подключения к ES
- **ACSearchConfig**: Конфигурация точного поиска
- **VectorSearchConfig**: Конфигурация векторного поиска

### 3. Главный сервис (`hybrid_search_service.py`)

- **HybridSearchService**: Реализует стратегию эскалации
  - AC поиск → Vector поиск (при необходимости)
  - Fallback на локальные индексы
  - Метрики и мониторинг

### 4. Адаптеры Elasticsearch (`elasticsearch_adapters.py`)

- **ElasticsearchACAdapter**: Адаптер для точного поиска
- **ElasticsearchVectorAdapter**: Адаптер для векторного поиска
- Заглушки с TODO для реальной интеграции

### 5. Тесты (`test_search_imports.py`)

- Тесты импорта всех компонентов
- Тесты создания объектов
- Тесты сериализации
- Тесты интерфейсов

## Интеграция с существующими слоями

### Слой 3: Нормализация
- Использует `NormalizationResult` для извлечения нормализованных имен
- Применяет токены и trace для улучшения поиска

### Слой 7: Эмбеддинги
- Интегрируется для генерации векторов запросов
- Использует существующие эмбеддинги для векторного поиска

### Слой 8: Decision
- Предоставляет результаты поиска для принятия решений
- Интегрируется с системой скоринга

## Стратегия эскалации

1. **AC поиск**: Точные/почти-точные совпадения по нормализованным ФИО, алиасам, юридическим наименованиям
2. **Эскалация**: Если AC не дал результата или дал слабый score → запуск векторного поиска
3. **Fallback**: Если Elasticsearch недоступен → использование локальных индексов

## TODO для интеграции

См. `integration_todos.md` для полного списка задач:

1. **Высокий приоритет**: Интеграция Elasticsearch клиента, регистрация сервиса
2. **Средний приоритет**: Fallback интеграция, API endpoints, базовое тестирование
3. **Низкий приоритет**: Продвинутый мониторинг, оптимизация производительности, функции безопасности

## Критерии готовности

✅ **Пройдено**:
- Проходит импорт всех модулей
- Есть конфигурация через pydantic-модели
- Интерфейсы совпадают с описанием
- Нет зависимостей на рантайм ES (используются заглушки)
- Все тесты проходят

## Следующие шаги

1. Установить зависимости Elasticsearch
2. Реализовать реальные ES адаптеры
3. Интегрировать с существующими слоями
4. Добавить API endpoints
5. Настроить мониторинг и метрики
