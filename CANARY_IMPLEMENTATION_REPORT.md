# Отчет о реализации канареечных тестов

## Обзор

Реализована полная инфраструктура канареечных тестов для нормализации имён, включающая:

1. **Канареечные тесты** (`tests/canary/`) - фиксированные кейсы для предотвращения регрессий
2. **Property-based тесты** (`tests/property/`) - тестирование инвариантов с помощью Hypothesis
3. **CI интеграция** - ежедневный запуск канареечных тестов
4. **Расширенная конфигурация** - новые маркеры и опции командной строки

## Структура файлов

### Канареечные тесты
```
tests/canary/
├── __init__.py
├── README.md
├── test_canary_suites.py          # Основной файл с параметризованными тестами
├── test_simple_canary.py          # Простые тесты для проверки инфраструктуры
└── data/
    ├── dangerous_surnames.yml     # Опасные фамилии (короткие, частые, омонимы)
    ├── transliteration.yml        # Транслиты (ru↔uk↔en), смешанные скрипты
    ├── homoglyphs.yml             # Гомоглифы (латинская a/о/е в кириллице, bidi)
    ├── apostrophes.yml            # Апострофы (' vs ')
    ├── hyphenated.yml             # Дефисные фамилии (двойные), инициалы с точками
    └── org_context.yml            # Org-контекст (ООО/ТОВ/LLC + CAPS)
```

### Property-based тесты
```
tests/property/
├── __init__.py
├── README.md
└── test_normalization_properties.py  # Property-based тесты с Hypothesis
```

## Реализованные функции

### 1. Канареечные тесты

**Категории тестов:**
- **Опасные фамилии** (20 кейсов) - короткие, частые, омонимы
- **Транслитерация** (20 кейсов) - ru↔uk↔en, смешанные скрипты  
- **Гомоглифы** (20 кейсов) - латинская a/о/е в кириллице, bidi
- **Апострофы** (20 кейсов) - ' vs '
- **Дефисные фамилии** (20 кейсов) - двойные фамилии, инициалы с точками
- **Org-контекст** (20 кейсов) - ООО/ТОВ/LLC + CAPS, чтобы не утекало в person

**Инварианты:**
- `must_contain` - обязательные токены в результате
- `must_not_contain` - запрещенные токены (например, "ООО", "ТОВ")
- `feminine_required` - требование женской формы
- `hyphen_preserved` - сохранение дефисов
- `initials_dot` - правильное форматирование инициалов

### 2. Property-based тесты

**Тестируемые свойства:**
- **Идемпотентность**: `normalize(normalize(x)) == normalize(x)`
- **Детерминистичность**: одинаковый вход дает одинаковый результат
- **Разумная длина**: результат не должен быть слишком длинным
- **Charset-subset**: нормализация не добавляет новых символов

**Стратегии генерации данных:**
- `name_text()` - тексты с именами на разных языках
- `cyrillic_text()` - кириллические тексты
- `latin_text()` - латинские тексты
- `mixed_script_text()` - тексты со смешанными скриптами

### 3. CI интеграция

**Новый job `canary_run`:**
- Запускается ежедневно в 6:00 UTC (cron)
- Запускается при ручном запуске workflow
- Включает строгую проверку производительности (`--strict-perf`)
- Генерирует отчет `canary_report.md`
- Сохраняет артефакты на 30 дней

**Пороги производительности:**
- p95 < 10ms для коротких текстов
- Среднее время < 5ms
- 50 итераций для измерения

### 4. Расширенная конфигурация

**Новые маркеры pytest:**
- `@pytest.mark.canary` - канареечные тесты
- `@pytest.mark.property` - property-based тесты
- `@pytest.mark.health_check` - тесты health checks

**Новые опции командной строки:**
- `--strict-perf` - строгая проверка производительности
- `--allow-order-swap` - разрешить перестановку порядка
- `--suppress-health-checks` - подавить предупреждения health checks

## Использование

### Локальный запуск

```bash
# Все канареечные тесты
pytest tests/canary/ -v

# С строгой проверкой производительности
pytest tests/canary/ --strict-perf

# Только быстрые тесты
pytest tests/canary/ -k "not slow"

# Property-based тесты
pytest tests/property/ -v

# С настройками Hypothesis
pytest tests/property/ --hypothesis-max-examples=100
```

### CI запуск

Канареечные тесты запускаются автоматически:
- Ежедневно в 6:00 UTC
- При push в main/develop ветки
- При создании pull request
- При ручном запуске workflow

## Результаты тестирования

Все базовые тесты проходят успешно:
- ✅ Структура файлов корректна
- ✅ YAML файлы валидны и содержат тестовые данные
- ✅ Классы тестов импортируются без ошибок
- ✅ Маркеры и опции командной строки настроены
- ✅ CI конфигурация добавлена

## Следующие шаги

1. **Интеграция с factory normalizer** - подключить реальную нормализацию
2. **Расширение тестовых данных** - добавить больше кейсов
3. **Мониторинг производительности** - настройка алертов при превышении порогов
4. **Документация** - обновление основной документации проекта

## Заключение

Инфраструктура канареечных тестов успешно реализована и готова к использованию. Система обеспечивает:

- **Предотвращение регрессий** через фиксированные кейсы
- **Проверку инвариантов** через property-based тесты  
- **Мониторинг производительности** через строгие пороги
- **Автоматизацию** через CI/CD интеграцию

Канареечные тесты будут ежедневно проверять стабильность нормализации имён и предотвращать появление критических ошибок.
