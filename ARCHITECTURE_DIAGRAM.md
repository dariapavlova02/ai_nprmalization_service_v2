# 🏗️ Архитектурная Диаграмма AI Service

## 9-Слойная Архитектура (CLAUDE.md Compliant)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ВХОДНЫЕ ДАННЫЕ                                     │
│                        "Оплата ТОВ 'ПРИВАТБАНК' Ивану Петрову"                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 0. КОНТРАКТЫ И ВАЛИДАЦИЯ (Pydantic Schemas)                                    │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ TextNormalization│ │ ProcessText     │ │ DecisionInput   │                    │
│ │ Request         │ │ Request         │ │                 │                    │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 1. ВАЛИДАЦИЯ И САНИТАРИЗАЦИЯ (ValidationService)                               │
│ • Проверка длины текста (max 10,000 символов)                                  │
│ • Санитизация HTML/XML тегов                                                   │
│ • Валидация кодировки UTF-8                                                    │
│ • Время: < 1ms                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 2. SMART FILTER (SmartFilterService) - КРИТИЧЕСКИЙ СЛОЙ                        │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ NameDetector    │ │ CompanyDetector │ │ DocumentDetector│                    │
│ │ • Капитализация │ │ • Юр. формы     │ │ • Номера        │                    │
│ │ • Инициалы      │ │ • Банки         │ │ • Даты          │                    │
│ │ • Отчества      │ │ • Котировки     │ │ • ID            │                    │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                    │
│ Результат: should_process=True, confidence=0.75, classification="high_risk"    │
│ Время: < 10ms                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 3. ДЕТЕКЦИЯ ЯЗЫКА (LanguageDetectionService)                                    │
│ • langdetect + custom rules для RU/UK/EN                                       │
│ • Анализ кириллицы/латиницы                                                    │
│ • Смешанные тексты поддержка                                                   │
│ Результат: language="ru", confidence=0.95                                      │
│ Время: < 5ms                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 4. UNICODE НОРМАЛИЗАЦИЯ (UnicodeService)                                       │
│ • NFC нормализация                                                              │
│ • Удаление невидимых символов                                                  │
│ • Стандартизация кавычек и тире                                                │
│ Результат: "Оплата ТОВ 'ПРИВАТБАНК' Ивану Петрову"                            │
│ Время: < 2ms                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 5. НОРМАЛИЗАЦИЯ ИМЕН (NormalizationService) - ЯДРО СИСТЕМЫ                     │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ Токенизация     │ │ Классификация   │ │ Морфология      │                    │
│ │ • Разбивка на   │ │ • given/surname │ │ • PyMorphy3     │                    │
│ │   токены        │ │ • patronymic    │ │ • SpaCy         │                    │
│ │ • Сохранение    │ │ • organization  │ │ • Лемматизация  │                    │
│ │   структуры     │ │ • unknown       │ │ • Падежи        │                    │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                    │
│ Результат: normalized="оплата тов приватбанк иван петров"                      │
│ Трассировка: [{"token":"Ивану","role":"given","normal_form":"иван"}]           │
│ Время: < 20ms                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 6. СИГНАЛЫ (SignalsService) - СТРУКТУРИРОВАНИЕ                                 │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ PersonExtractor │ │ OrgExtractor    │ │ IDExtractor     │                    │
│ │ • Имя+фамилия   │ │ • Юр. форма     │ │ • ИНН/ЄДРПОУ    │                    │
│ │ • Дата рождения │ │ • Полное название│ │ • Паспорт       │                    │
│ │ • ID документы  │ │ • ID организации│ │ • VAT           │                    │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                    │
│ Результат:                                                                      │
│ persons=[{core:["иван","петров"], dob:"1980-01-01", confidence:0.85}]          │
│ organizations=[{core:"приватбанк", legal_form:"ТОВ", confidence:0.90}]         │
│ Время: < 15ms                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 7. ВАРИАНТЫ (VariantGenerationService) - ОПЦИОНАЛЬНО                           │
│ • Морфологические варианты (падежи, склонения)                                 │
│ • Транслитерация (кириллица ↔ латиница)                                        │
│ • Фонетические варианты (Soundex, Metaphone)                                   │
│ • Типографические варианты (е/ё, и/й)                                          │
│ Результат: ["оплата тов приватбанк иван петров", "оплата тов приватбанк иван петров"] │
│ Время: < 10ms (если включено)                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 8. ЭМБЕДДИНГИ (EmbeddingService) - ОПЦИОНАЛЬНО                                 │
│ • sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2                  │
│ • 384-мерные векторы                                                           │
│ • Семантическое сходство                                                       │
│ • Исключение дат/ID (только имена/организации)                                 │
│ Результат: [0.123, -0.456, 0.789, ...] (384 floats)                           │
│ Время: < 50ms (если включено)                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 9. РЕШЕНИЕ И ОТВЕТ (DecisionEngine) - ФИНАЛЬНЫЙ СЛОЙ                           │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ Взвешенный      │ │ Классификация   │ │ Формирование    │                    │
│ │ скоринг         │ │ риска           │ │ ответа          │                    │
│ │ • SmartFilter   │ │ • SKIP (0-0.65) │ │ • JSON ответ    │                    │
│ │ • Персоны       │ │ • REVIEW (0.65- │ │ • Метрики       │                    │
│ │ • Организации   │ │   0.85)         │ │ • Трассировка   │                    │
│ │ • Схожесть      │ │ • AUTO_HIT      │ │ • Обоснование   │                    │
│ │ • Бонусы        │ │   (0.85-1.0)    │ │                 │                    │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                    │
│ Результат: {risk:"AUTO_HIT", score:0.87, reasons:["high_org_confidence"]}      │
│ Время: < 5ms                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ИТОГОВЫЙ ОТВЕТ                                     │
│ {                                                                               │
│   "original_text": "Оплата ТОВ 'ПРИВАТБАНК' Ивану Петрову",                    │
│   "normalized_text": "оплата тов приватбанк иван петров",                      │
│   "language": "ru",                                                             │
│   "signals": {                                                                  │
│     "persons": [{"core":["иван","петров"], "confidence":0.85}],                │
│     "organizations": [{"core":"приватбанк", "legal_form":"ТОВ"}]               │
│   },                                                                            │
│   "decision": {"risk":"AUTO_HIT", "score":0.87},                               │
│   "processing_time": 0.045,                                                     │
│   "success": true                                                               │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток Данных

```
Входной текст
     │
     ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ Валидация│───▶│Smart    │───▶│Language │───▶│Unicode  │
│         │    │Filter   │    │Detection│    │Norm     │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
     ▼              ▼              ▼              ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│Normalize│───▶│Signals  │───▶│Variants │───▶│Embedding│
│         │    │         │    │(opt)    │    │(opt)    │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
     ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────┐
│                Decision Engine                          │
│         (Взвешенная оценка риска)                      │
└─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────┐
│ Response│
│         │
└─────────┘
```

## ⚡ Производительность по Слоям

| Слой | Время | Описание |
|------|-------|----------|
| 1. Валидация | < 1ms | Быстрая проверка входных данных |
| 2. Smart Filter | < 10ms | Критический слой оптимизации |
| 3. Language Detection | < 5ms | Автоматическое определение языка |
| 4. Unicode | < 2ms | Нормализация кодировки |
| 5. Normalization | < 20ms | Ядро системы - морфология |
| 6. Signals | < 15ms | Извлечение структурированных данных |
| 7. Variants | < 10ms | Генерация вариантов (опционально) |
| 8. Embeddings | < 50ms | Векторное представление (опционально) |
| 9. Decision | < 5ms | Принятие решения о риске |
| **ИТОГО** | **< 50ms** | **Полная обработка** |

## 🎯 Ключевые Особенности

### Модульность
- Каждый слой независим и тестируем
- Легкая замена компонентов
- Гибкая конфигурация

### Производительность
- Асинхронная обработка
- Кэширование результатов
- Раннее прерывание при низком риске

### Надежность
- Обработка ошибок на каждом слое
- Fallback механизмы
- Детальная трассировка

### Масштабируемость
- Stateless архитектура
- Горизонтальное масштабирование
- Load balancing готовность

---

*Диаграмма подготовлена: Дарья Павлова*  
*Дата: Декабрь 2024*  
*Версия: 1.0*
