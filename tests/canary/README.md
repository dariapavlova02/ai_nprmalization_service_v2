# Канареечные тесты для нормализации имён

Этот пакет содержит фиксированные кейсы, которые исторически ломали нормализацию имён. Цель: предотвратить регрессии в критических сценариях нормализации.

## Структура

- `test_canary_suites.py` - Основной файл с параметризованными тестами
- `data/` - YAML файлы с тестовыми данными по категориям:
  - `dangerous_surnames.yml` - Опасные фамилии (короткие, частые, омонимы)
  - `transliteration.yml` - Транслиты (ru↔uk↔en), смешанные скрипты
  - `homoglyphs.yml` - Гомоглифы (латинская a/о/е в кириллице, bidi)
  - `apostrophes.yml` - Апострофы (' vs ')
  - `hyphenated.yml` - Дефисные фамилии (двойные), инициалы с точками
  - `org_context.yml` - Org-контекст (ООО/ТОВ/LLC + CAPS), чтобы не утекало в person

## Запуск тестов

### Локально
```bash
# Все канареечные тесты
pytest tests/canary/ -v

# С строгой проверкой производительности
pytest tests/canary/ --strict-perf

# Только быстрые тесты
pytest tests/canary/ -k "not slow"
```

### В CI
Канареечные тесты запускаются автоматически:
- Ежедневно в 6:00 UTC (cron)
- При ручном запуске workflow
- Результаты сохраняются как артефакты

## Инварианты

Каждый тестовый кейс проверяет следующие инварианты:

- `must_contain` - Обязательные токены в результате
- `must_not_contain` - Запрещенные токены (например, "ООО", "ТОВ")
- `feminine_required` - Требование женской формы
- `hyphen_preserved` - Сохранение дефисов
- `initials_dot` - Правильное форматирование инициалов

## Производительность

При включенном флаге `--strict-perf`:
- p95 < 10ms для коротких текстов
- Среднее время < 5ms
- 50 итераций для измерения

## Отчеты

CI генерирует отчет `canary_report.md` с:
- Результатами тестов
- Нарушениями инвариантов
- Метриками производительности
- Пороговыми значениями
