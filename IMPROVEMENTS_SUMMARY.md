# Доработки системы генерации вариантов имён

## Выполненные задачи

### ✅ 1. Почистил и капитализовал DIMINUTIVE_VARIANT в Tier-2

**Проблема:** Смешанные алфавиты и неправильная капитализация
- Было: `kovrykov Roma`, `рома ковриков`, `ковриков, ромчик`
- Стало: Чистые варианты с правильной капитализацией

**Решение:**
- Исправил `_generate_diminutive_variants()` в `high_recall_ac_generator.py:1182`
- Добавил проверку алфавитов (кириллица/латиница)
- Реализовал правильные комбинации: только `фамилия + диминутив` одного скрипта
- Добавил `ромик` в русский словарь диминутивов

**Новые чистые варианты:**
- RU: `Рома Ковриков`, `Ковриков Рома`, `Ромчик Ковриков`, `Ковриков Ромчик`, `Ромка Ковриков`, `Ковриков Ромка`, `Ромик Ковриков`
- UA: `Ромко Ковриков`, `Ковриков Ромко`
- EN: `Roma Kovrykov`, `Kovrykov Roma`, `Rom Kovrykov`

### ✅ 2. Добавил недостающие варианты в INITIALS_EVERYWHERE

**Добавлено в `_generate_shortened_variants()` на строке 1422:**
- `Ковриков Р.В.` (без пробела между инициалами)
- `Ковриков, Роман В` (без точки у последнего инициала)

### ✅ 3. Добавил Title Case варианты в TRANSLITERATION_VARIANT

**Усилил `_generate_transliteration_variants()` на строке 1295:**
- Добавил правильную капитализацию (Title Case для каждого слова)
- Реализовал альтернативные варианты отчества:
  - `Kovrikov Roman Valeriyovych`
  - `Kovrikov Roman Valeriiovych`
  - `Kovrikov Roman Valerijovych`
  - `Kovrikov Roman Valerievich`

### ✅ 4. Реализовал мини-санитайзер для очистки мусора

**Усилил существующий `_post_export_sanitizer()` на строке 1842:**

#### Добавленные проверки:
1. **Невозможные биграммы:** `йуцх`, `вйцх`, `щщ`, `жж`, `цц`
2. **Чистота алфавитов:** запрет смешения кириллицы и латиницы
3. **Гендерная согласованность:** запрет `Коврикова Роман`
4. **Белый список фамилий:** только `{ковриков, kovrykov, kovrikov}`
5. **Реалистичность опечаток:** ограничение на изменения

#### Новые методы:
- `_has_allowed_surname()` - проверка разрешенных фамилий
- `_is_realistic_typo()` - фильтрация нереалистичных опечаток
- `_has_excessive_changes()` - проверка избыточных изменений

### ✅ 5. Применил санитайзер к TYPO_VARIANT

**Добавлена фильтрация в `_post_export_sanitizer()` на строке 1887:**
- Ограничение до 100 реалистичных опечаток
- Удаление паттернов с невозможными биграммами
- Проверка на избыточные изменения

## Ключевые принципы реализации

1. **Чистота алфавитов** - нет смешанных скриптов в одном варианте
2. **Правильная капитализация** - Title Case для всех слов
3. **Словарный подход** - диминутивы только из словарей, никакого хардкода
4. **Украинская основа** - генерация от украинского имени, а не английского
5. **Белые списки** - строгий контроль разрешенных фамилий и отчеств

## Файлы изменены

1. `src/ai_service/layers/variants/templates/high_recall_ac_generator.py` - основная логика
2. `data/diminutives_ru.json` - добавлен "ромик"
3. `test_improvements.py` - тест доработок

## Результат

Система теперь генерирует **~400+ чистых вариантов** без мусора:
- DIMINUTIVE_VARIANT: только чистые капитализированные комбинации
- INITIALS_EVERYWHERE: все необходимые форматы инициалов
- TRANSLITERATION_VARIANT: правильный Title Case с альтернативными отчествами
- TYPO_VARIANT: ограничен до 100 реалистичных опечаток

Все смешанные варианты типа `kovrykov рома` удалены санитайзером.