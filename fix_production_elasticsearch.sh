#!/bin/bash
# URGENT: Fix production Elasticsearch and decision engine

echo "üö® URGENT PRODUCTION FIX - Decision Engine + Elasticsearch"
echo "=========================================================="

PROD_HOST="95.217.84.234"
PROD_USER="root"

echo ""
echo "üìã MANUAL DEPLOYMENT INSTRUCTIONS:"
echo ""
echo "üîó Connect to production server:"
echo "   ssh root@95.217.84.234"
echo ""
echo "üìç Navigate to project directory:"
echo "   cd /root/ai-service"
echo ""
echo "üîÑ Pull latest code (contains decision engine fix):"
echo "   git pull origin main"
echo ""
echo "üíæ Alternative: Manual edit decision_engine.py at line ~60:"
echo "   # Add this line to DecisionInput():"
echo "   search=inp.search"
echo ""
echo "üê≥ Rebuild and restart services:"
echo "   docker-compose down"
echo "   docker-compose build --no-cache ai-service"
echo "   docker-compose up -d"
echo ""
echo "‚è±Ô∏è Wait for services to start (30-60 seconds)"
echo "   docker logs ai-service -f"
echo ""
echo "üß™ Test the fix:"
echo "   curl -X POST http://95.217.84.234:8002/process \\"
echo "     -H 'Content-Type: application/json' \\"
echo "     -d '{\"text\": \"–ü–µ—Ç—Ä–æ –ü–æ—Ä–æ—à–µ–Ω–∫–æ\"}' | jq '.decision.score_breakdown'"
echo ""
echo "‚úÖ Expected result AFTER fix:"
echo "   {"
echo "     \"search_contribution\": 0.25,     # ‚Üê SHOULD APPEAR!"
echo "     \"smartfilter_contribution\": 0.075,"
echo "     \"person_contribution\": 0.18,"
echo "     \"total\": 0.505                   # ‚Üê risk_level becomes medium/high"
echo "   }"
echo ""
echo "‚ùå Current BROKEN result (before fix):"
echo "   {"
echo "     \"smartfilter_contribution\": 0.075,"
echo "     \"person_contribution\": 0.18,"
echo "     \"total\": 0.255                   # ‚Üê missing search_contribution!"
echo "   }"
echo ""
echo "üîç If search still returns 0 hits after fix:"
echo "   # Check Elasticsearch connectivity"
echo "   docker exec ai-service curl http://localhost:9200/_cluster/health"
echo "   "
echo "   # Check if patterns exist"
echo "   curl 'http://95.217.84.234:9200/ai_service_ac_patterns/_search' \\"
echo "     -H 'Content-Type: application/json' \\"
echo "     -d '{\"query\": {\"wildcard\": {\"pattern\": \"*–ø–æ—Ä–æ—à–µ–Ω–∫–æ*\"}}, \"size\": 3}'"
echo ""
echo "üöÄ BUSINESS IMPACT:"
echo "   BEFORE: AC finds sanctions ‚Üí still 'low risk' ‚Üí FALSE NEGATIVE ‚ùå"
echo "   AFTER:  AC finds sanctions ‚Üí 'high risk' ‚Üí CORRECT DETECTION ‚úÖ"
echo ""
echo "üî¥ CRITICAL: Direct sanctions matches are NOT being blocked!"
echo ""
