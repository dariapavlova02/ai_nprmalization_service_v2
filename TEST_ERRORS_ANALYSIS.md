# Анализ ошибок в тестах AI Normalization Service

## Общая статистика
- **Всего тестов:** 1461
- **Проходят:** 1188 (81.3%)
- **Не проходят:** 263 (18.0%)
- **Пропущены:** 10 (0.7%)

## Классификация ошибок

### 1. Технические ошибки (можно исправить)

#### 1.1 Ошибки импортов и модулей (21 ошибка)
```
AttributeError: <module 'ai_service.layers.smart_filter.name_detector' from...
```
**Причина:** Неправильные пути импорта после рефакторинга
**Решение:** Обновить импорты в тестах

#### 1.2 Ошибки конструкторов (8 ошибок)
```
TypeError: UnifiedProcessingResult.__init__() missing 3 required positional...
TypeError: MetricDefinition.__init__() got an unexpected keyword argument...
```
**Причина:** Изменения в сигнатурах конструкторов
**Решение:** Обновить вызовы конструкторов в тестах

#### 1.3 Ошибки методов (14 ошибок)
```
AttributeError: 'NormalizationService' object has no attribute 'language_co...
AttributeError: 'EmbeddingService' object has no attribute 'calculate_simil...
```
**Причина:** Переименование или удаление методов
**Решение:** Обновить вызовы методов в тестах

#### 1.4 Ошибки атрибутов (11 ошибок)
```
AttributeError: 'UnifiedProcessingResult' object has no attribute 'smartfil...
AttributeError: 'UnifiedOrchestrator' object has no attribute 'processing_s...
```
**Причина:** Изменения в структуре классов
**Решение:** Обновить обращения к атрибутам

### 2. Логические ошибки (требуют изменения логики)

#### 2.1 Ошибки в тестах API (12 ошибок)
```
KeyError: 'tokens'
TypeError: 'HTTPException' object is not callable
assert 503 == 422
```
**Причина:** Тесты ожидают другую структуру ответов API
**Статус:** Требует изменения API или тестов

#### 2.2 Ошибки в тестах нормализации (15 ошибок)
```
AssertionError: Expected 'Sherlock Holmes', but got 'Sherlock Holmes B.'
AssertionError: Expected 'Elon Musk', but got ''
AssertionError: Expected 'Петр Чайковский', but got 'Петр Чайковском'
```
**Причина:** Алгоритм нормализации работает не так, как ожидают тесты
**Статус:** Требует изменения алгоритма или тестов

#### 2.3 Ошибки в тестах морфологии (8 ошибок)
```
TypeError: list indices must be integers or slices, not str
AttributeError: 'MorphologicalAnalysis' object has no attribute 'get'
```
**Причина:** Изменения в структуре данных морфологического анализа
**Статус:** Требует обновления тестов

#### 2.4 Ошибки в тестах эмбеддингов (12 ошибок)
```
AttributeError: <src.ai_service.layers.embeddings.embedding_service.Embeddi...
TypeError: EmbeddingService.encode() got an unexpected keyword argument...
```
**Причина:** Изменения в API сервиса эмбеддингов
**Статус:** Требует обновления тестов

### 3. Ошибки конфигурации и инициализации

#### 3.1 Ошибки инициализации сервисов (6 ошибок)
```
ai_service.exceptions.ServiceInitializationError: Orchestrator creation fai...
AssertionError: assert False
```
**Причина:** Проблемы с инициализацией сервисов
**Статус:** Требует исправления конфигурации

#### 3.2 Ошибки метрик (5 ошибок)
```
KeyError: 'sum'
AttributeError: 'MetricsService' object has no attribute 'record_timing'
```
**Причина:** Изменения в API сервиса метрик
**Статус:** Требует обновления тестов

### 4. Ошибки производительности и ресурсов

#### 4.1 Ошибки рекурсии (1 ошибка)
```
RecursionError: maximum recursion depth exceeded
```
**Причина:** Бесконечная рекурсия в коде
**Статус:** Критическая ошибка, требует исправления

#### 4.2 Ошибки асинхронности (2 ошибки)
```
TypeError: object AsyncMock can't be used in 'await' expression
```
**Причина:** Неправильное использование моков в асинхронном коде
**Статус:** Требует исправления тестов

## Приоритеты исправления

### Высокий приоритет (критические ошибки)
1. **RecursionError** - может привести к падению сервиса
2. **ServiceInitializationError** - сервис не может запуститься
3. **Ошибки API** - нарушена основная функциональность

### Средний приоритет (функциональные ошибки)
1. **Ошибки нормализации** - основная бизнес-логика
2. **Ошибки морфологии** - важная часть обработки текста
3. **Ошибки эмбеддингов** - функциональность поиска

### Низкий приоритет (технические ошибки)
1. **Ошибки импортов** - легко исправить
2. **Ошибки конструкторов** - механические исправления
3. **Ошибки атрибутов** - обновление API

## Рекомендации

### Немедленные действия
1. Исправить RecursionError в тестах API
2. Исправить ошибки инициализации сервисов
3. Обновить импорты в тестах

### Краткосрочные задачи (1-2 недели)
1. Обновить тесты нормализации под текущий алгоритм
2. Исправить тесты морфологии
3. Обновить тесты эмбеддингов

### Долгосрочные задачи (1-2 месяца)
1. Пересмотреть архитектуру API
2. Улучшить обработку ошибок
3. Добавить интеграционные тесты

## Статистика по типам ошибок

| Тип ошибки | Количество | Процент |
|------------|------------|---------|
| AttributeError | 89 | 33.8% |
| AssertionError | 67 | 25.5% |
| TypeError | 45 | 17.1% |
| KeyError | 8 | 3.0% |
| Остальные | 54 | 20.5% |

## Заключение

Большинство ошибок (58.9%) связаны с изменениями в API и структуре классов после рефакторинга. Это технические ошибки, которые можно исправить относительно быстро. 

Оставшиеся 41.1% ошибок - это логические ошибки, которые требуют более глубокого анализа и могут потребовать изменения либо кода, либо тестов.

Рекомендуется начать с исправления технических ошибок, так как это даст быстрый результат и повысит покрытие тестами.
