# üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ü–†–û–î–ê–ö–®–ù –°–ï–†–í–ï–†–ê

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –∏–º–µ–Ω

**–ö–µ–π—Å 1**: "–ü–æ—Ä–æ—à–µ–Ω–∫–∞ –ü–µ—Ç–µ–Ω—å–∫–∞"
- üî¥ **–ü—Ä–æ–¥–∞–∫—à–Ω**: `"–ü–æ—Ä–æ—à–µ–Ω–∫–∞ | –ü–µ—Ç—Ä–æ"`
- ‚úÖ **–û–∂–∏–¥–∞–µ–º**: `"–ü–æ—Ä–æ—à–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ"`
- üêõ **–ü—Ä–æ–±–ª–µ–º–∞**: –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—è –≤—ã–¥–∞–µ—Ç –∂–µ–Ω—Å–∫—É—é —Ñ–æ—Ä–º—É "–ü–æ—Ä–æ—à–µ–Ω–∫–∞" –≤–º–µ—Å—Ç–æ –º—É–∂—Å–∫–æ–π "–ü–æ—Ä–æ—à–µ–Ω–∫–æ"

**–ö–µ–π—Å 2**: "–ü–∞–≤–ª–æ–≤–æ—ó –î–∞—Ä º—ó –Æ—Ä—ñ—ó–≤–Ω–∏"
- üî¥ **–ü—Ä–æ–¥–∞–∫—à–Ω**: `"–ü–∞–≤–ª–æ–≤ | –Æ—Ä—ñ—ó–≤–Ω–∞"` (–ø–æ—Ç–µ—Ä—è–ª–∏ –∏–º—è!)
- ‚úÖ **–û–∂–∏–¥–∞–µ–º**: `"–ü–∞–≤–ª–æ–≤–∞ –î–∞—Ä º—è –Æ—Ä—ñ—ó–≤–Ω–∞"`
- üêõ **–ü—Ä–æ–±–ª–µ–º—ã**:
  - –ü–∞–≤–ª–æ–≤–æ—ó ‚Üí –ü–∞–≤–ª–æ–≤ (–º—É–∂—Å–∫–∞—è —Ñ–æ—Ä–º–∞)
  - –î–∞—Ä º—ó –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–ª–æ—Å—å –∫–∞–∫ unknown

### 2. ‚ùå –ü–æ–∏—Å–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- SmartFilter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `"risk_level": "skip"`
- Elasticsearch search –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
```bash
–ü–∞–≤–ª–æ–≤–æ—ó ‚Üí –ü–∞–≤–ª–æ–≤–∞ ‚úÖ (–∂–µ–Ω—Å–∫–∞—è —Ñ–æ—Ä–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
–ü–æ—Ä–æ—à–µ–Ω–∫–∞ ‚Üí –ü–æ—Ä–æ—à–µ–Ω–∫–æ ‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è)
–î–∞—Ä º—ó ‚Üí –î–∞—Ä º—ó ‚úÖ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
```

### üîç Root Cause Analysis

**–ì–∏–ø–æ—Ç–µ–∑–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ feature flags –Ω–∞ –ø—Ä–æ–¥–µ**
```json
// –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–ª–∞–≥–∏:
"preserve_feminine_surnames": false  // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true
"enable_enhanced_gender_rules": false  // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true
"preserve_feminine_suffix_uk": false  // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true
```

**–ì–∏–ø–æ—Ç–µ–∑–∞ 2: Language detection**
- –ü—Ä–æ–¥–∞–∫—à–Ω trace –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `"language": "uk"` ‚úÖ
- –ù–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å FSM role classification –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–æ–≥–æ

**–ì–∏–ø–æ—Ç–µ–∑–∞ 3: –ö–µ—à/–≤–µ—Ä—Å–∏—è –∫–æ–¥–∞**
- –ü—Ä–æ–¥–∞–∫—à–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞
- –ò–ª–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

## –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### üö® –ù–ï–ú–ï–î–õ–ï–ù–ù–û (Critical):

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å feature flags –Ω–∞ –ø—Ä–æ–¥–µ**:
```bash
# –≠—Ç–∏ —Ñ–ª–∞–≥–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å true:
PRESERVE_FEMININE_SUFFIX_UK=true
ENABLE_ENHANCED_GENDER_RULES=true
PRESERVE_FEMININE_SURNAMES=true
ENABLE_FSM_TUNED_ROLES=true
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Smart Filter –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**:
```bash
# –ü–æ–∏—Å–∫ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å:
ENABLE_SMART_FILTER=true
ALLOW_SMART_FILTER_SKIP=false  # –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
ENABLE_AHO_CORASICK=true
ENABLE_VECTOR_FALLBACK=true
```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å** —Å –æ—á–∏—Å—Ç–∫–æ–π –∫–µ—à–∞

### üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Elasticsearch**:
   - –ò–Ω–¥–µ–∫—Å ac-patterns –∑–∞–≥—Ä—É–∂–µ–Ω?
   - Elasticsearch –¥–æ—Å—Ç—É–ø–µ–Ω?

5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–µ**:
   - –í–∫–ª—é—á–∏—Ç—å debug_tracing=true
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–µ trace –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –≥–¥–µ –ª–æ–º–∞–µ—Ç—Å—è

6. **–í–µ—Ä—Å–∏—è –∫–æ–¥–∞**:
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–¥
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Elasticsearch
curl "http://localhost:9200/_cluster/health"

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
curl "http://localhost:9200/ac-patterns/_count"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
env | grep -E "(PRESERVE|GENDER|FSM|SMART)"

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
docker-compose restart ai-service
```

## Expected Results –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```json
// "–ü–æ—Ä–æ—à–µ–Ω–∫–∞ –ü–µ—Ç–µ–Ω—å–∫–∞"
{
  "normalized_text": "–ü–æ—Ä–æ—à–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ",
  "decision": {"risk_level": "medium"}  // –Ω–µ skip!
}

// "–ü–∞–≤–ª–æ–≤–æ—ó –î–∞—Ä º—ó –Æ—Ä—ñ—ó–≤–Ω–∏"
{
  "normalized_text": "–ü–∞–≤–ª–æ–≤–∞ –î–∞—Ä º—è –Æ—Ä—ñ—ó–≤–Ω–∞",
  "decision": {"risk_level": "medium"}  // –Ω–µ skip!
}
```