# Диаграмма потока принятия решений

## 🔄 **Основной поток принятия решений**

```
┌─────────────────────────────────────────────────────────────────┐
│                    API Response Analysis                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Проверка risk_level                                        │
│    • "skip" → ПРОПУСТИТЬ ОБРАБОТКУ                             │
│    • "low"/"medium" → ПРОПУСТИТЬ ПЛАТЕЖ                        │
│    • "high" → Переход к шагу 2                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Проверка review_required                                   │
│    • false → РЕДЖЕКТ (блокировать)                             │
│    • true → Переход к шагу 3                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Анализ required_additional_fields                          │
│    • [] → РЕДЖЕКТ (блокировать)                                │
│    • ["TIN"] → ЗАПРОС TIN                                      │
│    • ["DOB"] → ЗАПРОС DOB                                      │
│    • ["TIN", "DOB"] → ЗАПРОС TIN+DOB                           │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 **Матрица решений**

```
┌─────────────────────────────────────────────────────────────────┐
│                    Decision Matrix                             │
├─────────────────────────────────────────────────────────────────┤
│ risk_level │ review_required │ required_fields │    Action     │
├─────────────────────────────────────────────────────────────────┤
│ skip       │ false          │ []              │ SKIP_PROCESS  │
│ low        │ false          │ []              │ APPROVE       │
│ medium     │ false          │ []              │ APPROVE       │
│ high       │ false          │ []              │ REJECT        │
│ high       │ true           │ []              │ REJECT        │
│ high       │ true           │ ["TIN"]         │ REQUEST_TIN   │
│ high       │ true           │ ["DOB"]         │ REQUEST_DOB   │
│ high       │ true           │ ["TIN","DOB"]   │ REQUEST_BOTH  │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 **Детальная логика для каждого сценария**

### **Сценарий 1: ПРОПУСТИТЬ ОБРАБОТКУ**
```
risk_level = "skip"
↓
Действие: Не обрабатывать платеж
Причина: Smart Filter определил отсутствие персональных данных
Пример: "тест", "hello", технические сообщения
```

### **Сценарий 2: ПРОПУСТИТЬ ПЛАТЕЖ**
```
risk_level = "low" OR "medium"
↓
Действие: Пропустить платеж
Причина: Низкий/средний риск, нет совпадений с санкционными списками
Пример: Обычные имена без совпадений
```

### **Сценарий 3: РЕДЖЕКТ (Блокировать)**
```
risk_level = "high" AND review_required = false
↓
Действие: Заблокировать платеж
Причина: Высокий риск + все необходимые данные (TIN/DOB) уже есть
Пример: Точное совпадение с полными данными
```

### **Сценарий 4: ЗАПРОС ДОПОЛНИТЕЛЬНЫХ ДАННЫХ**
```
risk_level = "high" AND review_required = true
↓
Действие: Запросить недостающие поля
Причина: Высокий риск + не хватает TIN или DOB для окончательного решения
Пример: Сильное совпадение имени, но нет TIN/DOB
```

## 🔍 **Анализ полей API ответа**

### **Критические поля для принятия решений:**

1. **`risk_level`** - Основной индикатор риска
2. **`review_required`** - Флаг необходимости дополнительных данных
3. **`required_additional_fields`** - Список требуемых полей
4. **`risk_score`** - Числовая оценка риска (0.0-1.0)
5. **`decision_reasons`** - Объяснения решения

### **Вспомогательные поля для анализа:**

1. **`smart_filter`** - Результаты предварительной фильтрации
2. **`signals`** - Извлеченные персональные данные
3. **`decision_details`** - Детальная информация о решении

## ⚙️ **Настройка порогов**

### **Пороги риска (настраиваемые):**
- **HIGH**: score ≥ 0.85 (по умолчанию)
- **MEDIUM**: 0.5 ≤ score < 0.85 (по умолчанию)
- **LOW**: score < 0.5 (по умолчанию)

### **Веса компонентов (настраиваемые):**
- **Smart Filter**: 25% (по умолчанию)
- **Person Data**: 30% (по умолчанию)
- **Organization Data**: 15% (по умолчанию)
- **Similarity**: 25% (по умолчанию)
- **Search Results**: 5% (по умолчанию)

## 🚨 **Обработка ошибок**

### **Ошибки обработки:**
```
success = false
↓
Действие: Запросить повторную обработку или ручную проверку
Причина: Техническая ошибка в системе
```

### **Неопределенные случаи:**
```
risk_level = "unknown"
↓
Действие: Ручная проверка
Причина: Система не смогла определить уровень риска
```

## 📈 **Мониторинг и алерты**

### **Критические метрики:**
1. **Частота высокого риска** - `risk_level = "high"`
2. **Запросы дополнительных данных** - `review_required = true`
3. **Пропуски обработки** - `risk_level = "skip"`
4. **Ошибки обработки** - `success = false`

### **Рекомендуемые алерты:**
- Резкое увеличение доли высокого риска (>20%)
- Высокая частота запросов дополнительных данных (>30%)
- Увеличение ошибок обработки (>5%)
- Необычные паттерны в decision_reasons

## 🎯 **Практические рекомендации**

### **Для интеграции:**
1. **Всегда проверяйте `success`** перед анализом других полей
2. **Используйте `risk_level`** как основной индикатор
3. **Проверяйте `review_required`** для высокого риска
4. **Анализируйте `decision_reasons`** для понимания причин
5. **Логируйте все решения** для аудита

### **Для мониторинга:**
1. **Отслеживайте распределение** `risk_level`
2. **Мониторьте частоту** `review_required`
3. **Анализируйте паттерны** в `decision_reasons`
4. **Контролируйте производительность** через `processing_time`

Эта схема обеспечивает **прозрачное** и **детерминистическое** принятие решений на основе полей API ответа.
